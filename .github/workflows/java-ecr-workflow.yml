# ç®€æ´çš„ Java ECR æž„å»º Workflow
name: Build Java to Docker Image and Push to ECR

on:
  workflow_call:
    inputs:
      aws-region:
        description: "AWS region"
        required: false
        default: "ap-east-1"
        type: string
      aws-account-id:
        description: "AWS Account ID"
        required: false
        default: "865258959313"
        type: string
      keep-images:
        description: "Number of images to keep"
        required: false
        default: 20
        type: number
    secrets:
      aws-access-key-id:
        description: "AWS Access Key ID"
        required: true
      aws-secret-access-key:
        description: "AWS Secret Access Key"
        required: true
    outputs:
      image-uri:
        description: "Built image URI"
        value: ${{ jobs.build-push.outputs.image-uri }}
      image-tag:
        description: "Built image tag"
        value: ${{ jobs.build-push.outputs.image-tag }}

jobs:
  build-push:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    env:
      AWS_REGION: ${{ inputs.aws-region }}
      ECR_REGISTRY: ${{ inputs.aws-account-id }}.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com
    
    outputs:
      image-uri: ${{ steps.vars.outputs.image-uri }}
      image-tag: ${{ steps.vars.outputs.image-tag }}
      
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Set Variables
        id: vars
        run: |
          TIMESTAMP=$(date -u '+%Y%m%d-%H%M%S')
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          IMAGE_TAG="${BRANCH_NAME}-${SHORT_SHA}-${TIMESTAMP}"
          IMAGE_URI="${ECR_REGISTRY}/${REPO_NAME}:${IMAGE_TAG}"
          
          echo "ECR_REPOSITORY=$REPO_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          echo "ðŸ·ï¸ Image Tag: $IMAGE_TAG"
          echo "ðŸ“¦ Repository: $REPO_NAME"
          
      - name: ðŸ” Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          
      - name: ðŸ—ï¸ Create ECR Repository
        run: |
          echo "ðŸ” Checking ECR repository: $ECR_REPOSITORY"
          
          if aws ecr describe-repositories --repository-names $ECR_REPOSITORY --region $AWS_REGION >/dev/null 2>&1; then
            echo "âœ… Repository exists"
          else
            echo "ðŸ†• Creating repository with lifecycle policy"
            
            # åˆ›å»ºä»“åº“
            aws ecr create-repository \
              --repository-name $ECR_REPOSITORY \
              --region $AWS_REGION \
              --image-scanning-configuration scanOnPush=true
            
            # è®¾ç½®ç”Ÿå‘½å‘¨æœŸç­–ç•¥
            aws ecr put-lifecycle-configuration \
              --repository-name $ECR_REPOSITORY \
              --region $AWS_REGION \
              --lifecycle-policy-text '{
                "rules": [
                  {
                    "rulePriority": 1,
                    "description": "Keep last ${{ inputs.keep-images }} images",
                    "selection": {
                      "tagStatus": "any",
                      "countType": "imageCountMoreThan",
                      "countNumber": ${{ inputs.keep-images }}
                    },
                    "action": {
                      "type": "expire"
                    }
                  }
                ]
              }'
            
            echo "âœ… Repository created with lifecycle policy"
          fi
          
      - name: ðŸ”‘ Login to ECR
        uses: aws-actions/amazon-ecr-login@v2
          
      - name: ðŸ³ Build and Push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: https://raw.githubusercontent.com/wujunlin555/workflows/main/.github/workflows/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.IMAGE_URI }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.TIMESTAMP }}
          build-args: |
            VERSION=${{ env.IMAGE_TAG }}
            GIT_COMMIT=${{ github.sha }}
            BUILDTIME=${{ env.TIMESTAMP }}
            
      - name: ðŸ§¹ Cleanup Old Images
        run: |
          echo "ðŸ—‘ï¸ Cleaning up old images (keeping latest ${{ inputs.keep-images }})"
          
          # èŽ·å–æ‰€æœ‰é•œåƒï¼ŒæŒ‰æŽ¨é€æ—¶é—´æŽ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
          IMAGES=$(aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --region $AWS_REGION \
            --query 'sort_by(imageDetails,&imagePushedAt)[:-${{ inputs.keep-images }}].[imageDigest]' \
            --output text)
          
          if [ -n "$IMAGES" ] && [ "$IMAGES" != "None" ]; then
            echo "ðŸ—‘ï¸ Found old images to delete"
            
            # åˆ é™¤æ—§é•œåƒ
            for digest in $IMAGES; do
              if [ "$digest" != "None" ] && [ -n "$digest" ]; then
                echo "Deleting image: $digest"
                aws ecr batch-delete-image \
                  --repository-name $ECR_REPOSITORY \
                  --region $AWS_REGION \
                  --image-ids imageDigest=$digest >/dev/null 2>&1 || true
              fi
            done
            
            echo "âœ… Cleanup completed"
          else
            echo "â„¹ï¸ No old images to delete"
          fi
          
      - name: ðŸ“Š Repository Status
        run: |
          # èŽ·å–é•œåƒæ•°é‡å’Œæ€»å¤§å°
          REPO_INFO=$(aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --region $AWS_REGION \
            --query '[length(imageDetails), sum(imageDetails[].imageSizeInBytes)]' \
            --output text)
          
          IMAGE_COUNT=$(echo $REPO_INFO | awk '{print $1}')
          TOTAL_SIZE_BYTES=$(echo $REPO_INFO | awk '{print $2}')
          TOTAL_SIZE_MB=$(echo "scale=1; $TOTAL_SIZE_BYTES / 1024 / 1024" | bc -l 2>/dev/null || echo "N/A")
          
          echo "ðŸ“Š Repository Status:"
          echo "   Images Count: $IMAGE_COUNT"
          echo "   Total Size: ${TOTAL_SIZE_MB} MB"
          echo "   Repository: $ECR_REPOSITORY"
          
      - name: ðŸ“‹ Build Summary
        run: |
          echo "## ðŸ³ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Image Tag | \`$IMAGE_TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Image URI | \`$IMAGE_URI\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—‚ï¸ Repository | \`$ECR_REPOSITORY\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Commit | \`$(echo ${{ github.sha }} | cut -c1-7)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Keep Images | \`${{ inputs.keep-images }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“Š ECR Console](https://console.aws.amazon.com/ecr/repositories/private/${{ inputs.aws-account-id }}/$ECR_REPOSITORY)" >> $GITHUB_STEP_SUMMARY
