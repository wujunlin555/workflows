# å¤šé˜¶æ®µæ„å»ºçš„ Java Spring Boot Dockerfile
# å…¼å®¹ Maven å’Œ Gradle é¡¹ç›®ï¼Œæ”¯æŒ Java 8/11/17/21

# ====================================
# é˜¶æ®µ 1: æ„å»ºé˜¶æ®µ
# ====================================
FROM eclipse-temurin:17-jdk-alpine AS builder

# è®¾ç½®æ„å»ºå‚æ•°ï¼ˆä» GitHub Actions ä¼ å…¥ï¼‰
ARG BUILDTIME
ARG VERSION
ARG GIT_COMMIT
ARG GIT_BRANCH

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…å¿…éœ€çš„æ„å»ºå·¥å…·
RUN apk add --no-cache \
    curl \
    bash \
    findutils

# å¤åˆ¶æ„å»ºæ–‡ä»¶
COPY pom.xml* build.gradle* gradle.properties* gradlew* settings.gradle* ./
COPY gradle/ gradle/ 2>/dev/null || true

# æ ¹æ®é¡¹ç›®ç±»å‹ä¸‹è½½ä¾èµ–
RUN if [ -f "pom.xml" ]; then \
        echo "ğŸ“¦ æ£€æµ‹åˆ° Maven é¡¹ç›®ï¼Œä¸‹è½½ä¾èµ–..."; \
        # ä½¿ç”¨ Maven Wrapper æˆ–ç³»ç»Ÿ Maven
        if [ -f "mvnw" ]; then \
            chmod +x mvnw && ./mvnw dependency:go-offline -B; \
        else \
            # å®‰è£… Maven
            apk add --no-cache maven && \
            mvn dependency:go-offline -B; \
        fi; \
    elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then \
        echo "ğŸ“¦ æ£€æµ‹åˆ° Gradle é¡¹ç›®ï¼Œä¸‹è½½ä¾èµ–..."; \
        chmod +x gradlew && \
        ./gradlew dependencies --no-daemon; \
    else \
        echo "âš ï¸ æœªæ£€æµ‹åˆ°æ„å»ºæ–‡ä»¶ï¼Œè·³è¿‡ä¾èµ–ä¸‹è½½"; \
    fi

# å¤åˆ¶æºä»£ç 
COPY src/ src/

# æ„å»ºåº”ç”¨
RUN if [ -f "pom.xml" ]; then \
        echo "ğŸ—ï¸ ä½¿ç”¨ Maven æ„å»º..."; \
        if [ -f "mvnw" ]; then \
            ./mvnw clean package -DskipTests -B; \
        else \
            mvn clean package -DskipTests -B; \
        fi; \
        # æ‰¾åˆ°æ„å»ºçš„ JAR æ–‡ä»¶
        find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" -exec cp {} app.jar \;; \
    elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then \
        echo "ğŸ—ï¸ ä½¿ç”¨ Gradle æ„å»º..."; \
        ./gradlew build -x test --no-daemon; \
        # æ‰¾åˆ°æ„å»ºçš„ JAR æ–‡ä»¶
        find build/libs -name "*.jar" -not -name "*-plain.jar" -exec cp {} app.jar \;; \
    else \
        echo "âŒ æœªæ‰¾åˆ°æ„å»ºæ–‡ä»¶ï¼Œæ„å»ºå¤±è´¥"; \
        exit 1; \
    fi

# éªŒè¯ JAR æ–‡ä»¶æ˜¯å¦å­˜åœ¨
RUN if [ ! -f "app.jar" ]; then \
        echo "âŒ æ„å»ºå¤±è´¥ï¼šæ‰¾ä¸åˆ° JAR æ–‡ä»¶"; \
        ls -la target/ build/libs/ 2>/dev/null || true; \
        exit 1; \
    else \
        echo "âœ… æ„å»ºæˆåŠŸï¼ŒJAR æ–‡ä»¶å¤§å°: $(du -h app.jar | cut -f1)"; \
    fi

# ====================================
# é˜¶æ®µ 2: è¿è¡Œæ—¶é˜¶æ®µ
# ====================================
FROM eclipse-temurin:17-jre-alpine AS runtime

# è®¾ç½®æ„å»ºå‚æ•°
ARG BUILDTIME
ARG VERSION
ARG GIT_COMMIT
ARG GIT_BRANCH

# è®¾ç½®æ ‡ç­¾
LABEL maintainer="your-team@company.com" \
      org.opencontainers.image.title="Java Spring Boot Application" \
      org.opencontainers.image.description="Production-ready Java application" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.created="${BUILDTIME}" \
      org.opencontainers.image.revision="${GIT_COMMIT}" \
      org.opencontainers.image.source="https://github.com/your-org/your-repo" \
      build.time="${BUILDTIME}" \
      build.version="${VERSION}" \
      build.commit="${GIT_COMMIT}" \
      build.branch="${GIT_BRANCH}"

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    curl \
    bash \
    dumb-init && \
    # è®¾ç½®æ—¶åŒº
    cp /usr/share/zoneinfo/Asia/Hong_Kong /etc/localtime && \
    echo "Asia/Hong_Kong" > /etc/timezone

# åˆ›å»ºåº”ç”¨ç›®å½•
RUN mkdir -p /app/config /app/logs /app/tmp && \
    chown -R appuser:appgroup /app

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶ JAR æ–‡ä»¶
COPY --from=builder --chown=appuser:appgroup /app/app.jar ./app.jar

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > start.sh << 'EOF'
#!/bin/bash
set -e

# æ‰“å°å¯åŠ¨ä¿¡æ¯
echo "=================================="
echo "ğŸš€ Starting Java Application"
echo "ğŸ“¦ Version: ${VERSION:-unknown}"
echo "ğŸ”— Commit: ${GIT_COMMIT:-unknown}"
echo "ğŸŒ¿ Branch: ${GIT_BRANCH:-unknown}"
echo "â° Build Time: ${BUILDTIME:-unknown}"
echo "ğŸ•’ Current Time: $(date)"
echo "ğŸ’¾ Available Memory: $(free -h | grep Mem | awk '{print $7}')"
echo "ğŸ–¥ï¸  CPU Cores: $(nproc)"
echo "=================================="

# JVM å‚æ•°è®¾ç½®
JAVA_OPTS="${JAVA_OPTS} -XX:+UseContainerSupport"
JAVA_OPTS="${JAVA_OPTS} -XX:MaxRAMPercentage=75.0"
JAVA_OPTS="${JAVA_OPTS} -XX:+UseG1GC"
JAVA_OPTS="${JAVA_OPTS} -XX:+UseStringDeduplication"
JAVA_OPTS="${JAVA_OPTS} -XX:+PrintGCDetails"
JAVA_OPTS="${JAVA_OPTS} -XX:+PrintGCTimeStamps"
JAVA_OPTS="${JAVA_OPTS} -Xloggc:/app/logs/gc.log"
JAVA_OPTS="${JAVA_OPTS} -XX:+UseGCLogFileRotation"
JAVA_OPTS="${JAVA_OPTS} -XX:NumberOfGCLogFiles=5"
JAVA_OPTS="${JAVA_OPTS} -XX:GCLogFileSize=10M"

# Spring Boot å‚æ•°
JAVA_OPTS="${JAVA_OPTS} -Dspring.profiles.active=${SPRING_PROFILES_ACTIVE:-prod}"
JAVA_OPTS="${JAVA_OPTS} -Dserver.port=${SERVER_PORT:-8080}"
JAVA_OPTS="${JAVA_OPTS} -Djava.security.egd=file:/dev/./urandom"
JAVA_OPTS="${JAVA_OPTS} -Dfile.encoding=UTF-8"
JAVA_OPTS="${JAVA_OPTS} -Duser.timezone=Asia/Hong_Kong"

# å¥åº·æ£€æŸ¥å‚æ•°
JAVA_OPTS="${JAVA_OPTS} -Dmanagement.endpoints.web.exposure.include=health,info,metrics,prometheus"
JAVA_OPTS="${JAVA_OPTS} -Dmanagement.endpoint.health.show-details=always"

# å¦‚æœè®¾ç½®äº†è°ƒè¯•æ¨¡å¼
if [ "${JAVA_DEBUG}" = "true" ]; then
    echo "ğŸ› Debug mode enabled"
    JAVA_OPTS="${JAVA_OPTS} -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
fi

# æ‰“å°æœ€ç»ˆçš„ JVM å‚æ•°
echo "ğŸ”§ JVM Options: ${JAVA_OPTS}"
echo "=================================="

# å¯åŠ¨åº”ç”¨
exec java ${JAVA_OPTS} -jar app.jar "$@"
EOF

# è®¾ç½®å¯åŠ¨è„šæœ¬æƒé™
RUN chmod +x start.sh && chown appuser:appgroup start.sh

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:${SERVER_PORT:-8080}/actuator/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8080 5005

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV SPRING_PROFILES_ACTIVE=prod \
    SERVER_PORT=8080 \
    JAVA_OPTS="" \
    TZ=Asia/Hong_Kong

# ä½¿ç”¨ dumb-init ä½œä¸º PID 1ï¼Œé¿å…åƒµå°¸è¿›ç¨‹
ENTRYPOINT ["dumb-init", "--"]

# å¯åŠ¨å‘½ä»¤
CMD ["./start.sh"]

# ====================================
# æ„å»ºæ—¶éªŒè¯
# ====================================
# åœ¨æ„å»ºæ—¶è¿è¡Œä¸€äº›åŸºæœ¬æ£€æŸ¥
RUN echo "âœ… Dockerfile æ„å»ºå®Œæˆ" && \
    echo "ğŸ“ å·¥ä½œç›®å½•å†…å®¹:" && \
    ls -la && \
    echo "ğŸ“¦ JAR æ–‡ä»¶ä¿¡æ¯:" && \
    file app.jar && \
    echo "ğŸ‘¤ å½“å‰ç”¨æˆ·: $(whoami)" && \
    echo "ğŸ  Home ç›®å½•: $HOME"
