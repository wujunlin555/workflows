name: Build Java to Docker Image and Push to ECR
on:
  workflow_call:
    inputs:
      aws-region:
        description: "AWS region"
        required: false
        default: "ap-east-1"
        type: string
      dockerfile-path:
        description: "Path to Dockerfile"
        required: false
        default: "Dockerfile"
        type: string
      platforms:
        description: "Target platforms"
        required: false
        default: "linux/amd64"
        type: string
      java-version:
        description: "Java version for testing"
        required: false
        default: "17"
        type: string
      enable-tests:
        description: "Enable unit tests"
        required: false
        default: true
        type: boolean
    secrets:
      aws-access-key-id:
        description: "AWS Access Key ID"
        required: true
      aws-secret-access-key:
        description: "AWS Secret Access Key"
        required: true
      
jobs:
  build-test-and-push:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ inputs.aws-region }}
      ECR_REGISTRY: 390402541453.dkr.ecr.${{ inputs.aws-region }}.amazonaws.com
    
    outputs:
      image-uri: ${{ steps.build-vars.outputs.image-uri }}
      image-tag: ${{ steps.build-vars.outputs.image-tag }}
      
    steps:
      # 01. æ£€å‡ºä»£ç 
      - name: 01. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      # 02. è®¾ç½® Java ç¯å¢ƒï¼ˆç”¨äºæµ‹è¯•ï¼‰
      - name: 02. è®¾ç½® Java ${{ inputs.java-version }}
        if: ${{ inputs.enable-tests }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: maven
          
      # 03. è¿è¡Œå•å…ƒæµ‹è¯•
      - name: 03. è¿è¡Œå•å…ƒæµ‹è¯•
        if: ${{ inputs.enable-tests }}
        run: |
          if [ -f "pom.xml" ]; then
            mvn clean test
          elif [ -f "build.gradle" ]; then
            ./gradlew test
          else
            echo "No Maven or Gradle build file found, skipping tests"
          fi
          
      # 04. è®¾ç½®å˜é‡å¹¶æ‰“å°ä¿¡æ¯
      - name: 04. è®¾ç½®æ„å»ºå˜é‡
        id: build-vars
        run: |
          # åˆ†æ”¯åå¤„ç†ï¼šå°† / æ›¿æ¢ä¸º -ï¼Œé¿å… Docker tag é—®é¢˜
          BRANCH_NAME="${{ github.ref_name }}"
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g' | tr '[:upper:]' '[:lower:]')
          echo "BRANCH_NAME=$SAFE_BRANCH_NAME" >> $GITHUB_ENV
          
          # ä»“åº“åï¼šé¡¹ç›®åç§°è½¬å°å†™
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          echo "ECR_REPOSITORY=$REPO_NAME" >> $GITHUB_ENV
          
          # é•œåƒæ ‡ç­¾ï¼šåˆ†æ”¯-æäº¤SHAå‰7ä½-æ—¶é—´æˆ³
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M")
          IMAGE_TAG="${SAFE_BRANCH_NAME}-${SHORT_SHA}-${TIMESTAMP}"
          TIMESTAMP_TAG=$(date -u +"%Y%m%d-%H%M%S")
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "TIMESTAMP_TAG=$TIMESTAMP_TAG" >> $GITHUB_ENV
          
          # å®Œæ•´é•œåƒ URI
          IMAGE_URI="${{ env.ECR_REGISTRY }}/${REPO_NAME}:${IMAGE_TAG}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          
          # è¾“å‡ºåˆ° GitHub Actions outputs
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          # æ‰“å°ä¿¡æ¯
          echo "ğŸ—ï¸ Repository: $REPO_NAME"
          echo "ğŸ·ï¸ Image Tag: $IMAGE_TAG"
          echo "â° Timestamp Tag: $TIMESTAMP_TAG"
          echo "ğŸ“¦ Full Image URI: $IMAGE_URI"
          
      # 05. é…ç½® AWS è®¤è¯
      - name: 05. é…ç½® AWS è®¤è¯
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}
          
      # 06. åˆ›å»º ECR ä»“åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      - name: 06. åˆ›å»º ECR ä»“åº“
        run: |
          echo "ğŸ” æ£€æŸ¥ ECR ä»“åº“æ˜¯å¦å­˜åœ¨..."
          if aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} --region ${{ inputs.aws-region }} 2>/dev/null; then
            echo "âœ… ECR ä»“åº“å·²å­˜åœ¨: ${{ env.ECR_REPOSITORY }}"
          else
            echo "ğŸ†• åˆ›å»º ECR ä»“åº“: ${{ env.ECR_REPOSITORY }}"
            aws ecr create-repository \
              --repository-name ${{ env.ECR_REPOSITORY }} \
              --region ${{ inputs.aws-region }} \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
            
            # è®¾ç½®ç”Ÿå‘½å‘¨æœŸç­–ç•¥
            aws ecr put-lifecycle-configuration \
              --repository-name ${{ env.ECR_REPOSITORY }} \
              --region ${{ inputs.aws-region }} \
              --lifecycle-policy-text '{
                "rules": [
                  {
                    "rulePriority": 1,
                    "description": "Keep last 20 images",
                    "selection": {
                      "tagStatus": "any",
                      "countType": "imageCountMoreThan",
                      "countNumber": 20
                    },
                    "action": {
                      "type": "expire"
                    }
                  }
                ]
              }'
            echo "âœ… ECR ä»“åº“åˆ›å»ºå®Œæˆå¹¶è®¾ç½®ç”Ÿå‘½å‘¨æœŸç­–ç•¥"
          fi
          
      # 07. ç™»å½• Amazon ECR
      - name: 07. ç™»å½• Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        
      # 08. è®¾ç½® Docker Buildx
      - name: 08. è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      # 09. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: 09. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.dockerfile-path }}
          platforms: ${{ inputs.platforms }}
          push: true
          tags: |
            ${{ env.IMAGE_URI }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.TIMESTAMP_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      # 10. è¾“å‡ºæ„å»ºç»“æœ
      - name: 10. æ„å»ºå®Œæˆ
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ é•œåƒå·²æ¨é€åˆ°: ${{ env.IMAGE_URI }}"
          echo "ğŸ”— ECR æ§åˆ¶å°: https://console.aws.amazon.com/ecr/repositories/private/${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}"
